# ASM-Hawk Development Environment

services:
  # ===================
  # Databases
  # ===================
  postgres:
    image: postgres:16-alpine
    container_name: asm-hawk-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: asm_hawk
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - asm-hawk-network

  clickhouse:
    image: clickhouse/clickhouse-server:24-alpine
    container_name: asm-hawk-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - asm-hawk-network

  # ===================
  # Cache & Queue
  # ===================
  redis:
    image: redis:7-alpine
    container_name: asm-hawk-redis
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "6379:6379"
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
      - redis_data:/data
    networks:
      - asm-hawk-network

  # ===================
  # Reverse Proxy
  # ===================
  nginx:
    image: nginx:alpine
    container_name: asm-hawk-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - api
      - web
    networks:
      - asm-hawk-network

  # ===================
  # Application Services
  # ===================
  api:
    build:
      context: ./api
      dockerfile: ../docker/api.Dockerfile
    container_name: asm-hawk-api
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/asm_hawk
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PORT=3100
    ports:
      - "3100:3100"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ./api:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock
      - temp_data:/tmp
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - asm-hawk-network

  recon:
    build:
      context: ./recon
      dockerfile: Dockerfile
    container_name: asm-hawk-recon
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/asm_hawk
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8443:8443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - temp_data:/tmp
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - asm-hawk-network

  workers:
    build:
      context: ./workers
      dockerfile: ../docker/workers.Dockerfile
    container_name: asm-hawk-workers
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/asm_hawk
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY}
      - CENSYS_API_ID=${CENSYS_API_ID}
      - CENSYS_API_SECRET=${CENSYS_API_SECRET}
    depends_on:
      - redis
      - postgres
    networks:
      - asm-hawk-network

  web:
    build:
      context: ./web
      dockerfile: ../docker/web.Dockerfile
    container_name: asm-hawk-web
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3100
    ports:
      - "3101:3101"
    depends_on:
      - api
    networks:
      - asm-hawk-network

  # ===================
  # Recon Tools (Phase 2)
  # ===================
  subfinder:
    build: ./docker/subfinder
    container_name: asm-hawk-subfinder
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  httpx:
    build: ./docker/httpx
    container_name: asm-hawk-httpx
    volumes:
      - temp_data:/tmp
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  nuclei:
    build: ./docker/nuclei
    container_name: asm-hawk-nuclei
    volumes:
      - temp_data:/tmp
    entrypoint: ["sleep", "infinity"]
    shm_size: '2g'
    restart: "no"
    networks:
      - asm-hawk-network

  katana:
    build:
      context: ./docker/katana
      dockerfile: Dockerfile
    container_name: asm-hawk-katana
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    volumes:
      - temp_data:/tmp
    entrypoint: ["sleep", "infinity"]
    restart: unless-stopped
    networks:
      - asm-hawk-network

  dnsx:
    build: ./docker/dnsx
    container_name: asm-hawk-dnsx
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  ffuf:
    build: ./docker/ffuf
    container_name: asm-hawk-ffuf
    volumes:
      - ./wordlists:/wordlists
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  gospider:
    build:
      context: .
      dockerfile: docker/gospider/Dockerfile
    container_name: asm-hawk-gospider
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
        reservations:
          memory: 512M
          cpus: '0.5'
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  waybackurls:
    build: ./docker/waybackurls
    container_name: asm-hawk-waybackurls
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  shuffledns:
    build: ./docker/shuffledns
    container_name: asm-hawk-shuffledns
    volumes:
      - ./docker/shuffledns/wordlists:/app/wordlists
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  cewl:
    build: ./docker/cewl
    container_name: asm-hawk-cewl
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  assetfinder:
    build: ./docker/assetfinder
    container_name: asm-hawk-assetfinder
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  metabigor:
    build: ./docker/metabigor
    container_name: asm-hawk-metabigor
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  sublist3r:
    build: ./docker/sublist3r
    container_name: asm-hawk-sublist3r
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  subdomainizer:
    build:
      context: .
      dockerfile: docker/subdomainizer/Dockerfile
    container_name: asm-hawk-subdomainizer
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  github-recon:
    build: ./docker/github-recon
    container_name: asm-hawk-github-recon
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  cloud_enum:
    build:
      context: .
      dockerfile: docker/cloud_enum/Dockerfile
    container_name: asm-hawk-cloud-enum
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

  linkfinder:
    build: ./docker/linkfinder
    container_name: asm-hawk-linkfinder
    entrypoint: ["sleep", "infinity"]
    restart: "no"
    networks:
      - asm-hawk-network

volumes:
  postgres_data:
  clickhouse_data:
  redis_data:
  temp_data:

networks:
  asm-hawk-network:
    driver: bridge
